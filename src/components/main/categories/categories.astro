---
import "./categories.css";
// import { categoryData } from "@/data/categoryData.js";
import CardMain from "@/components/cards/CardMain.astro";
import type { Listing } from "../../../types/listing.type";

const listingAPI = await fetch(`${import.meta.env.API_LIST_URL}?status=published`);
const listingData = await listingAPI.json();
const categoryData = listingData.data;
---

<section class="destinations section-padding">
  <div class="container">
    <div class="section-header" style="flex-direction: column; align-items: flex-start;">
      <h2 data-key="gallery_title">Organiza tu viaje</h2>
      <p data-key="gallery_desc" style="margin-bottom: 1.5rem; color: var(--secondary-text);">Explora actividades, lugares y servicios disponibles en el puerto y el rancho.</p>
      <div class="filter-chips">
        <button class="chip active" data-key="cat_all" data-category="all">Todo</button>
        <button class="chip" data-key="cat_experiences" data-category="experiences">Experiencias</button>
        <button class="chip" data-key="cat_sites" data-category="sites">Sitios de Interés</button>
        <button class="chip" data-key="cat_accommodation" data-category="accommodation">Alojamiento</button>
        <button class="chip" data-key="cat_restaurants" data-category="restaurants">Restaurantes</button>
        <button class="chip" data-key="cat_services" data-category="services">Servicios</button>
      </div>

      <!-- Dynamic Category Content -->
      <div class="category-content">
        <div id="category-carousel-container" class="carousel-container">
          <!-- Cards will be injected here by JS -->
          {console.log("Rendering initial cards...", categoryData)}
          {categoryData.map((item: Listing) => <CardMain item={item} currentLang={"es"} />)}
        </div>
        <div class="view-all-container">
          <a href="#" class="view-all-link" id="view-all-link" data-key="view_all">Ver todo <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  import { categoryData } from "../data/categoryData.js";
  import CardMain from "@/components/cards/CardMain.astro";

  function renderCards(category) {
    const container = document.getElementById("category-carousel-container");
    container.innerHTML = ""; // Clear existing

    const filteredData = category === "all" ? categoryData : categoryData.filter((item) => item.category === category);

    if (filteredData.length === 0) {
      container.innerHTML = `<p style="width: 100%; text-align: center; color: var(--secondary-text);">No hay resultados para esta categoría.</p>`;
      return;
    }

    filteredData.forEach((item) => {
      const card = <CardMain item={item} currentLang={(currentLang = "es")} />;
      container.appendChild(card);
    });

    // Update View All link visibility/text based on category if needed
    // For now, it just stays as "Ver todo" / "View all"
  }

  // Category Chips
  const chips = document.querySelectorAll(".chip");
  chips.forEach((chip) => {
    chip.addEventListener("click", () => {
      chips.forEach((c) => c.classList.remove("active"));
      // Add active class to clicked
      chip.classList.add("active");
      // Render cards
      const category = chip.getAttribute("data-category");
      renderCards(category);
    });
  });
</script>
