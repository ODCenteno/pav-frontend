---
import "./categories.css";
// import { categoryData } from "@/data/categoryData.js";
import CardMain from "@/components/cards/CardMain.astro";
import type { Listing } from "../../../types/listing.type";
import { useTranslations } from "../../../i18n/utils";

const t = useTranslations(Astro.currentLocale);

const listingAPI = await fetch(`${import.meta.env.API_LIST_URL}?status=published`);
const listingData = await listingAPI.json();
const categoryData = listingData.data;
---

<section class="destinations section-padding">
  <div class="container">
    <div class="section-header" style="flex-direction: column; align-items: flex-start;">
      <h2 data-key="gallery_title">{t('gallery.title')}</h2>
      <p data-key="gallery_desc" style="margin-bottom: 1.5rem; color: var(--secondary-text);">{t('gallery.desc')}</p>
      <div class="filter-chips">
        <button class="chip active" data-key="cat_all" data-category="all">{t('categories.all')}</button>
        <button class="chip" data-key="cat_experiences" data-category="experiences">{t('categories.experiences')}</button>
        <button class="chip" data-key="cat_sites" data-category="sites">{t('categories.sites')}</button>
        <button class="chip" data-key="cat_accommodation" data-category="accommodation">{t('categories.accommodation')}</button>
        <button class="chip" data-key="cat_restaurants" data-category="restaurants">{t('categories.restaurants')}</button>
        <button class="chip" data-key="cat_services" data-category="services">{t('categories.services')}</button>
      </div>

      <!-- Dynamic Category Content -->
      <div class="category-content">
        <div id="category-carousel-container" class="carousel-container" data-no-results-text={t('gallery.noResults')}>
          <!-- Cards will be injected here by JS -->
          {console.log("Rendering initial cards...", categoryData)}
          {categoryData.map((item: Listing) => <CardMain item={item} currentLang={Astro.currentLocale} />)}
        </div>
        <div class="view-all-container">
          <a href="#" class="view-all-link" id="view-all-link" data-key="view_all">{t('gallery.view_all')} <i class="fas fa-arrow-right"></i></a>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  import { categoryData } from "../data/categoryData.js";
  import CardMain from "@/components/cards/CardMain.astro";

  function renderCards(category) {
    const container = document.getElementById("category-carousel-container");
    const noResultsText = container.dataset.noResultsText;
    container.innerHTML = ""; // Clear existing

    const filteredData = category === "all" ? categoryData : categoryData.filter((item) => item.category === category);

    if (filteredData.length === 0) {
      container.innerHTML = `<p style="width: 100%; text-align: center; color: var(--secondary-text);">${noResultsText}</p>`;
      return;
    }

    filteredData.forEach((item) => {
      const card = <CardMain item={item} currentLang={(currentLang = "es")} />;
      container.appendChild(card);
    });

    // Update View All link visibility/text based on category if needed
    // For now, it just stays as "Ver todo" / "View all"
  }

  // Category Chips
  const chips = document.querySelectorAll(".chip");
  chips.forEach((chip) => {
    chip.addEventListener("click", () => {
      chips.forEach((c) => c.classList.remove("active"));
      // Add active class to clicked
      chip.classList.add("active");
      // Render cards
      const category = chip.getAttribute("data-category");
      renderCards(category);
    });
  });
</script>
